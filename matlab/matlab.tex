%\documentclass{beamer}
\documentclass[handout]{beamer}

\usepackage{pgfpages} 

%\setbeameroption{show only notes}

\usetheme{default}

\mode<presentation> {
%  \usetheme{Warsaw}
  \usetheme{Frankfurt}
%  \usetheme{Boadilla}
%  \usetheme{Marburg}
}

\mode<handout>{\setbeamercolor{background canvas}{bg=black!5} %
    \pgfpagesuselayout{4 on 1}[letterpaper,border shrink=4mm,landscape] %
    \setbeameroption{show notes}}

\title[MATLAB for Research Computing] {MATLAB for Research Computing}
\author{Brock Palen\\ \texttt{brockp@umich.edu}}

\begin{document}
  \setbeamercovered{transparent}  
  \begin{frame}
    \titlepage
  \end{frame}

%table of contents
  \begin{frame}{Outline}
    \tableofcontents
  \end{frame}
  
  \section{Running MATLAB}
   \subsection{Invoking General MATLAB}
   \begin{frame}{MATLAB}
    \begin{block}{Load MATLAB Module}
         \texttt{module load matlab}
    \end{block}
    \begin{block}{Running MATLAB Core}
     \begin{itemize}
      \item If your mfile is scriptname.m drop the .m when running \\
        \texttt{matlab -singleCompThread -r scriptname} 
      \item If your mfile takes arguments, escape the ()'s with $\backslash$'s \\
        \texttt{matlab -singleCompThread -r function$\backslash$(arg1,arg2$\backslash$)}
     \end{itemize}
    \end{block}
    \note{ Modules Docs: http://cac.engin.umich.edu/resources/software/modules.html \\ Use of \texttt{-singleCompThread} will be explained latter in matlab with threads. The CAC used to use \texttt{maxNumCompThreads\(N\)} where N was the number of parallel threads matlab should use. MathWorks depercated the use of that function, and currently the only way is use all threads (not acceptable in a batch environment) or a single thread use the single thread option.
   } %notes
    
   \end{frame}


   \subsection{Compiling with MCC}
   \begin{frame}{MCC the MATLAB Compiler}
    \begin{block}{MCC the MATLAB Compiler}
     This is what most people running code a batch system such as the CAC resources should be using. \\
     MCC takes your mcode wraps it with the needed MATLAB libraries to run the code without having MATLAB licenses or Toolbox licneses.
    \end{block}
    \begin{block}{Web Documentation}
     \url{http://cac.engin.umich.edu/resources/software/mcc.html}
    \end{block}
   \end{frame}
 
   \begin{frame}{MCC Usage}
    \begin{block}{Compiling with MCC}
     \texttt{mcc -R -singleCompThread -m simple.m -I includes/} \\
     \texttt{./simple}
    \end{block}
    \begin{block}{simple.m}
     \texttt{rand2(5)}
    \end{block}
    \begin{block}{includes/rand2.m}
     \texttt{function [out1] = rand2(arg1) \\
out1 = rand(arg1);}
    \end{block}
    \note{\texttt{mcc} is capable of much more, it can also build: dynamic shared objects, callable from C/C++/Fortran, allowing the mixing or matlab into those languages rather than the normal mixing them into matlab using mex files. \\
  The -I flag is the most problemmatic for people, it points to mfiles that you call that are not in MATLABPATH. \\
Full \texttt{mcc} documentation from MathWorks: \url{http://www.mathworks.de/access/helpdesk/help/toolbox/compiler/mcc.html}
    } %note
   \end{frame}
   \begin{frame}{MCC and exernal Mfiles}
    \begin{block}{Calling Custom Functions}
     If your main mfile calls other mfiles they must be handeled with care:
     \begin{itemize}
      \item Use \texttt{-I directory/} to add them to the search path internal to matlab
      \item Multiple \texttt{-I} may be given to the compiler of the files are in multiple locations
     \end{itemize}
    \end{block}
    \begin{block}{Common Error from not including needed paths}
    \texttt{??? Undefined function or method 'rand2' for input arguments of type 'double'.}
    \end{block}
    \note{ \texttt{mcc} will compile anything you give it, and will not throw errors if the code is not allowed to be compiled, or if the needed include options were not given to it. Errors will only appear at runtime. \\
When passing values to \texttt{-I directory/}  the space is important. \texttt{mcc} will fail to compile if passed \texttt{-Idirectory/}. \\
 Users can also use \texttt{-a directory/*.m}  for force all mfiles in that location to be bundeled into the executable. Most users do not need this but it is another option.

    } %note
   \end{frame}

   
   \begin{frame}{MCC Limitations}
    \begin{block}{MCC Limits}
     \begin{itemize}
     \item Cannot call SIMULINK models, sim()
     \item Cannot use the local parallel configuration (more latter)
     \item Not all toolboxes supported: \\
      \url{http://www.mathworks.com/products/compiler/compiler\_support.html}
     \end{itemize}
    \end{block}
   \end{frame}

   \begin{frame}{Passing Arguments to MCC}
    \begin{block}{Everything Passed as a String}
     \begin{itemize}
      \item Compiling with MCC is very slow
      \item <2->Solution!
      \item <3->Compile a function and pass arguemnts
      \item <3->All arguements are passed as strings
     \end{itemize}
    \end{block}
    \begin{block}{Example}
     \texttt{matlab -r myfcn$\backslash$(arg1,arg2$\backslash$)}
     \\ becomes \\
     \texttt{./myfcn arg1 arg2}
    \end{block}
   \end{frame}

\begin{frame}[fragile]
    \frametitle{Compiling Functions Ctd}
    \begin{block}{Example Code}
    \begin{semiverbatim}
	function m = myfcn(arg1, arg2)
	if ischar(arg1)
	   arg1=str2num(arg1);
	end
	if ischar(arg2)
	   arg2=str2num(arg2);
	end
    \end{semiverbatim}
    \end{block}
    \note{ By using the \texttt{if ischar(arg)} check even when this code is not compiled and ran from normal matlab it will work just fine. Thus this check is safe to use in all cases.  The power of a compiled function is that users can compile once (compiling with mcc is slow) and run multiple cases passing arguments from the command line. This allows for a compile once run many situation, saving time and effort.

    } %note
\end{frame}

   \section{Dealing with MATLAB Threads}
  \begin{frame}{Implicit Threads}
   \begin{block}{Threads for MATLAB Functions}
    \begin{itemize}
     \item Many MATLAB functions are multi-threaded
     \item MATLAB uses all cores on systems by default
     \item Use \texttt{ matlab -singleCompThread -r <input>} to force single thread
     \item \texttt{maxNumCompThreads(N)} sets the number of threads but should nolonger be used
     \item Only use a single thread on CAC nodes due to control (Working with MathWorks on this limitation)
     \item Don't confuse with Parallel Computing Toolbox, every MATLAB has this functionality
    \end{itemize}
   \end{block}
  \end{frame}

\begin{frame}[fragile]
\frametitle{Implicit Thread Example}
   \begin{block}{Thread Example}
\texttt{matlab -r implicitthreads$\backslash$(10000$\backslash$)} \\
Solves Ax=b
   \end{block}
   \begin{block}{Example}
    \texttt{
A=rand(dim); \\
b=rand(dim,1); \\
x=zeros(dim,1); \\
tic \\
x=A$\backslash$b;\\
toc  }
  \end{block}
\note{
On login-amd3 using a dim of 10000 on 4 cores takes 60 seconds to solve, 5000 takes 10 seconds.  When ran with \texttt{-singleCompThread} 5000 takes 27 seconds. Many interal functions and toolboxes support this type of parallelism for free. It will not be discused much due to the lack of control over the number of threads used in a shared environment.
} %note
\end{frame}
    %both compiler and normal matlab, dont confuse with DCT
  \section{Parallel Computing Toolbox}
   \begin{frame}{Prallel Computing Toolbox}
    \begin{block}{PCT/DCT}
     \begin{itemize}
      \item Formerly known as Distributed Computing Toolbox (DCT)
      \item Can work inside or along batch systems (PBS on CAC systems)
      \item Provides explicit parallel programming
      \item Supports 4 types of parallelism
      \begin{itemize}
       \item parfor
       \item distributed jobs
       \item parallel jobs
       \item single program multiple data (SPMD)
      \end{itemize}
     \end{itemize}
    \end{block}
   \end{frame}

   \subsection{parfor}
\begin{frame}[fragile]
\frametitle{PARFOR}
    \begin{block}{Parallel for loop}
     \begin{semiverbatim}
      \texttt{
matlabpool open local 4
{\bf parfor} i=1:100  
   A(i)=i;   
end

\%reduction
x=0;   
{\bf parfor} i=1:100 
   x=x+i;  
end
matlabpool close  }  
     \end{semiverbatim}
    \end{block}
\note{parfor can be tricky it has many limitations, and looks simpler at first look.  In general if you are familure with OpenMP programming the same restrictions apply to parfor().  Parfor documentation is available in the MATLAB PCT pages. In general, if your parallel varable is incrimented in your code (in our examles i) it will not work in parfor.  A way to think of this is, can my parfor if ran serial, work forwards and backwards?  If it can only work forwards parfor will not work.
} %note
\end{frame}

\begin{frame}{matlabpool what is it}
  \begin{block}{matlabpool open $<$config$>$ N}
   Starts a group of cores parallel codes will run on. Pools should be left open till all parallel work is finished. Starting pools takes a long time.  Pools should also always be closed.
  \end{block}
  \begin{block}{local configuration}
   \begin{itemize}
    \item Available on all PCT toolbox machines
    \item Supports single node only
    \item Limited for 8 cores (increases over time)
   \end{itemize}
  \end{block}
  \note{pools startup parallel configurations.  These are not easy to make but are known to work on nyx. The local config every matlab with PCT comes with can be ran on a lab machine or desktop.  It does not require any PCT engine licenses and thus is great for debugging or running smaller single node jobs. Note that pools that use the local config can not be compiled with mcc.  The number of cores the local config is limited to is 8 with current version (2009a/b) MathWorks has raised the limit as cpus add more and more cores. It is very kind of them to do this and allows real work to be done without having any PCT engines.
  } %note
\end{frame}

   \subsection{Distributed Jobs}
   \begin{frame}{Distributed Jobs}
    \begin{block}{Distributed Jobs}
     \begin{itemize}
      \item A single job runs several unrelated tasks
      \item Works directly with the batch system (PBS) to submit each task as a cluster job
      \item Does not require a PBS file as MATLAB talks to PBS for you
      \item Host MATLAB does not require to be running when tasks run
      \item MATLAB can read results from tasks back in
     \end{itemize}
    \end{block}
   \end{frame}

\begin{frame}[fragile]
   \frametitle{Distributed Job Example}
     \begin{semiverbatim}
sched=findResource('scheduler', 'type', 'torque') 
%Do NOT set nodes, ppn or tpn 
set(sched,'SubmitArguments','-l walltime=24:00:00 -q cac')
%Create a job  
job1=createJob(sched) 

%add a few tasks, each task will be a one cpu jobs in PBS 
createTask(job1, @rand, 1, {3,3});
createTask(job1, @rand, 1, {3,3});
get(job1, 'Tasks')  

%Submit job and its tasks to the cluster 
submit(job1)  
%you may now exit matlab
     \end{semiverbatim}
\note{
The sched object holds the information about how long you need memory etc.  These are in the SubmitArguments property that matches that of a similar PBS job.
You can create multiple jobs with their own tasks and submit them all.  Note in distributed jobs do not set to use multiple cpus or processors per node (ppn). Each task is a {\bf single} core job. Distributed jobs are parallel in the sense that each of these single cpu tasks run on their own cpu at the same time. These tasks are then farmed out to the cluster via pbs. They each write their own results to mat files in a format that can be read back in by the cluster.
} %note 
\end{frame}

\begin{frame}[fragile]
\frametitle{Reading Distributed Jobs}
  \begin{semiverbatim}
sched=findResource('scheduler', 'type', 'torque')

job = findJob(sched)
tasks = findTask(job)
results = getAllOutputArguments(job)

results\{1,1\}
results\{2,1\}
  \end{semiverbatim}
\note{
Note using \texttt{getAllOutputArguments} loads all of the data from the tasks into the memory of the host matlab, this could be to large, there are ways in the PCT manual to read data Task at a time, or even a subset of data from a task, such that all task data does not need to be held in memory at once. The example assumes a single job in the directory matlab is ran in, if you have more than one the \texttt{find} functions all take options by name wallclock etc to fins a specific job and results etc.
} %note
\end{frame}

   \subsection{Parallel Jobs}
   \begin{frame}{Parallel Jobs}
    \begin{block}{Default Modules}
     Distrbuted MATLAB jobs require that \texttt{module load matlab} is in your default modules on login. \\
\url{http://cac.engin.umich.edu/resources/software/modules.html}
    \end{block}
    \begin{block}{Parallel Jobs}
     Parallel jobs are those in which the workers (or labs) can communicate with each other during the evaluation of their tasks. 
    \end{block}
    \note{
Parallel jobs are really the MPI for matlab. When you submit a parallel job (again MATLAB submits the PBS job for you) it will be a single multiple cpus PBS unlike distributed jobs where each is a single cpu multiple PBS job.  MATLAB also provides higher level functions in parallel jobs that minimizes the amount of parallel programming dificulty the user has.
} %note
   \end{frame}
   
\begin{frame}[fragile]
\frametitle{Parallel Job Setup}
 \begin{semiverbatim}
sched=findResource('scheduler', 'type', 'torque')
set(sched, 'SubmitArguments', '-l walltime=15:00
             -q cac -M brockp@umich.edu -m abe')
pjob=createParallelJob(sched);
set(pjob, 'MaximumNumberOfWorkers', 4)
set(pjob, 'MinimumNumberOfWorkers', 4)
set(pjob, 'FileDependencies', {'colsum.m'})
t=createTask(pjob, @colsum, 1, {})
submit(pjob)
waitForState(pjob)
results=getAllOutputArguments(pjob)
destroy(pjob)
 \end{semiverbatim}
\end{frame}

\begin{frame}[fragile]
\frametitle{Parallel Kernel}
\begin{semiverbatim}
function total\_sum = colsum
if labindex == 1
  % Send magic square to other labs 
  A = labBroadcast(1,magic(numlabs))
else
  % Receive broadcast on other labs 
  A = labBroadcast(1)
end

% Calculate sum of column identified by labindex for this lab 
column\_sum = sum(A(:,labindex))
% Calculate total sum by combining column sum from all labs 
total\_sum = gplus(column\_sum)
\end{semiverbatim}
\end{frame}

   \subsection{SPMD}
%TODO
   \subsection{Creating a Prallel Configuration}
\begin{frame}{Prallel Configurations}
\begin{block}{What is a Prallel Config?}
 \begin{itemize}
  \item MATLAB Prefers parallel configs
  \item CAC does not
  \item Inflexable from the command line
  \item Some parallel features require configs and cannot use the \texttt{findResource()} function
  \begin{itemize}
   \item Anything that uses \texttt{matlabpool}
   \item SPMD
  \end{itemize}
 \end{itemize}
\end{block}
\end{frame}

\begin{frame}{Torque/PBS Prallel Configs}
 Contact the CAC \url{cac-support@umich.edu} for help, All settings should be left to the defaults unless listed
 \begin{block}{Torque configs}
  \begin{itemize}
   \item {\bf ResourceTemplate:}\\ \texttt{-V -l nodes=\^{}N\^{},gres=matlab\_distrib\_comp\_engin:\^{}N\^{}}
    \begin{itemize}
     \item {Add other PBS options here \texttt{qos, -A, preempt, etc}}
    \end{itemize}
  \end{itemize}
 \end{block}
\end{frame}

\begin{frame}{mpiexec Parallel Configs}
 \begin{block}{MPIEXEC Config}
  \begin{itemize}
   \item {\bf EnvironmentSetMethod:} \texttt{setenv}
   \item {\bf MpiexecFileName:} \\ \texttt{/home/software/rhel5/mpiexec/0.83/bin/mpiexec}
  \end{itemize}
 \end{block}
 \begin{block}{~/matlab/mpiLibConf.m}
  \texttt{function [lib, extras] = mpiLibConf} \\
  \texttt{lib = '/home/software/rhel5/mpich2/1.2.1p1/lib/libmpich.so';} \\
  \texttt{extras = \{\};}
 \end{block}
\end{frame}

\begin{frame}{When to use Torque/PBS or mpiexec}
 \begin{block}{Which config to use?}
  \begin{itemize}
   \item Avoid parallel configs if you can
   \item Use Torque if submitting work from nyx-login {\bf from MATLAB}
   \item Use mpiexec if running matlab from a PBS script 
  \end{itemize}
 \end{block}
\note{This is confusing, the PBS case is if MATLAB is submitting your job for you, you never run qsub, etc. The mpiexec case (the recomended) is where you submit a PBS job with qsub like any other code on a cluster and that PBS script runs MATLAB which calls your parallel config. \\
We really wish this was simpler but it is not. \\
\texttt{mpiLibConf.m} must go in \texttt{~/matlab/} it cannot be in the normal MATLAB PATH due to bugs in the software. Note that the path to \texttt{libmpich.so} and the path to mpiexec are subjet to change. Example after a major upgrade of a CAC cluster the path will change. Another example is if you wish to run MATLAB over infiniband such as the FLUX cluster.
} %note
\end{frame}

  \section{Licencing}
  \begin{frame}{Licencing}
   \begin{block}{MATLAB is not free}
    \begin{itemize}
     \item If mcode is compiled with \texttt{mcc} {\bf NO} licenses are needed and you can ignore the rest of this
     \item MATLAB/SIMULINK and Toolboxes/Blocksets all have their own licenses.
     \item The CAC and CAEN do not have equal number of all licenses
     \item The CAC shares tokens with CAEN lab machines
     \item If you cannot use \texttt{mcc} on your mcode you {\bf MUST} request licneses on the cluster via PBS
     \item Classroom tokens are to not be used for research, this is wrong and illegal
    \end{itemize}
   \end{block}
  \end{frame}

   \subsection{Interacting with PBS and GRES}
\begin{frame}[fragile]
\frametitle{PBS and GRES}
    \begin{block}{Do not ignore this message}
     \begin{semiverbatim}
There are a limited number of matlab licenses
Request the number each job needs like so:
	 #PBS -l nodes=1,walltime=24:00:00,gres=matlab
	 #PBS -l nodes=1,gres=matlab%Communication_toolbox
Requests one matlab and one Communication_toolbox
     \end{semiverbatim}
    \end{block}
\end{frame}
\begin{frame}{PBS and Licneses}
    \begin{block}{qsub -l gres=matlab\%simulink}
     \begin{itemize}
      \item There can be only one \texttt{gres=} line
      \item If requesting multiple licenses seperate with \%
      \item We do not track all Toolboxes/Blocksets Contact the CAC to track the ones you use
      \item Check what we do track: \\
\texttt{diagnose -n DEFAULT}
     \end{itemize}
    \end{block}
\note{Not all toolboxes/blocksets need to be tracked. Those that have many installed and there is not a limitation do not need to be tracked. If users submit jobs or run jobs that get FLEXlm errors this is because of licenses and should contact cac-support@umich.edu to have those tokens tracked.
} % note
\end{frame}
   \subsection{Parallel Computing Toolbox}
   \begin{frame}{Prallel Computing Toolbox Tokens}
    \begin{block}{PCT is different}
     \begin{itemize}
      \item PCT jobs use only \texttt{matlab\_distrib\_comp\_engine} tokens 
      \item No toolbox or MATLAB tokens are needed for workers only engines
      \item Users only need to request engine tokens if submitting using the mpiexec parallel config
      \begin{itemize}
       \item \texttt{gres=matlab\_dist\_comp\_engine:N}
       \item N is the number of workers
       \item If MATLAB submits your PBS job for you this can be ignored
      \end{itemize}
     \end{itemize}
    \end{block}
\note{Using PCT users can streach limited licneses. Any worker running under PCT does not use any licneses other than the single engin license. Engins are much cheaper than many toolboxes.  Though you must have at least one valid license for the toolbox for the PCT worker to allow those features. That token is not used when the worker runs and does not even need to be available at the time the worker starts.
} %note
   \end{frame}
  \section{Optimizing Matlab with mlint}
   \subsection{Resizing Arrays}
   \subsection{mlint Hints}
   \subsection{mex files}
    %nag library here
  \section{Survey}
  %exit survey
\end{document}
